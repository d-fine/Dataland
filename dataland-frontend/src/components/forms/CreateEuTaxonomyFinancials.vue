<template>
  <Card class="col-12 page-wrapper-card p-3" style="background: var(--p-surface-50)">
    <template #title
      ><span data-test="pageWrapperTitle"> {{ editMode ? 'Edit ' : 'Create ' + frameworkTitle }} </span></template
    >
    <template #content>
      <div class="separator" />
      <div v-if="waitingForData" class="d-center-div text-center px-7 py-4">
        <p class="font-medium text-xl">Loading EU Taxonomy Financials data...</p>
        <DatalandProgressSpinner />
      </div>
      <div v-else class="grid uploadFormWrapper">
        <div id="uploadForm" class="text-left uploadForm col-9">
          <FormKit
            v-model="companyAssociatedEuTaxonomyFinancialsData"
            :actions="false"
            type="form"
            :id="formId"
            :name="formId"
            @submit="postEuTaxonomyFinancialsData"
            @submit-invalid="checkCustomInputs"
          >
            <FormKit type="hidden" name="companyId" :model-value="companyID" />
            <div class="uploadFormSection grid">
              <div class="col-3 p-3 topicLabel">
                <h4 id="reportingPeriod" class="anchor title">Reporting Period</h4>
              </div>
              <div class="col-9 form-field formFields uploaded-files">
                <UploadFormHeader
                  :label="'Reporting Period'"
                  :description="'The reporting period the dataset belongs to (e.g. a fiscal year).'"
                  :is-required="true"
                />
                <div class="lg:col-4 md:col-6 col-12 pl-0">
                  <DatePicker
                    data-test="reportingPeriod"
                    v-model="reportingPeriod"
                    inputId="icon"
                    :showIcon="true"
                    view="year"
                    dateFormat="yy"
                    validation="required"
                  />
                </div>

                <FormKit type="hidden" :modelValue="reportingPeriodYear.toString()" name="reportingPeriod" />
              </div>
            </div>

            <FormKit type="group" name="data" label="data">
              <FormKit
                type="group"
                v-for="category in eutaxonomyFinancialsDataModel"
                :key="category.name"
                :label="category.label"
                :name="category.name"
              >
                <div
                  class="uploadFormSection grid"
                  v-for="subcategory in category.subcategories"
                  :key="subcategory.name"
                >
                  <template v-if="subcategoryVisibility.get(subcategory) ?? true">
                    <div class="col-3 p-3 topicLabel">
                      <h4 :id="subcategory.name" class="anchor title">{{ subcategory.label }}</h4>
                      <Tag :value="category.label.toUpperCase()" severity="secondary" />
                    </div>

                    <div class="col-9 formFields">
                      <FormKit
                        v-for="field in subcategory.fields"
                        :key="field.name"
                        type="group"
                        :name="subcategory.name"
                      >
                        <component
                          v-if="field.showIf(companyAssociatedEuTaxonomyFinancialsData.data)"
                          :is="field.component"
                          :label="field.label"
                          :placeholder="field.placeholder"
                          :description="field.description"
                          :name="field.name"
                          :options="field.options"
                          :required="field.required"
                          :validation="field.validation"
                          :validation-label="field.validationLabel"
                          :data-test="field.name"
                          :unit="field.unit"
                          @reports-updated="updateReportsSelection"
                          :ref="field.name"
                        />
                      </FormKit>
                    </div>
                  </template>
                </div>
              </FormKit>
            </FormKit>
          </FormKit>
        </div>
        <SubmitSideBar class="jumpLinks">
          <SubmitButton :formId="formId" />
          <div v-if="postEuTaxonomyFinancialsDataProcessed">
            <SuccessMessage v-if="uploadSucceded" :messageId="messageCounter" />
            <FailMessage v-else :message="message" :messageId="messageCounter" />
          </div>

          <h4 id="topicTitles" class="title pt-3">On this page</h4>
          <ul>
            <li v-for="category in eutaxonomyFinancialsDataModel" :key="category.name">
              <ul>
                <li v-for="subcategory in category.subcategories" :key="subcategory.name">
                  <a
                    v-if="subcategoryVisibility.get(subcategory) ?? true"
                    @click="smoothScroll(`#${subcategory.name}`)"
                    >{{ subcategory.label }}</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </SubmitSideBar>
      </div>
    </template>
  </Card>
</template>
<script lang="ts">
import UploadFormHeader from '@/components/forms/parts/elements/basic/UploadFormHeader.vue';
import BigDecimalExtendedDataPointFormField from '@/components/forms/parts/fields/BigDecimalExtendedDataPointFormField.vue';
import CurrencyDataPointFormField from '@/components/forms/parts/fields/CurrencyDataPointFormField.vue';
import DateExtendedDataPointFormField from '@/components/forms/parts/fields/DateExtendedDataPointFormField.vue';
import DateFormField from '@/components/forms/parts/fields/DateFormField.vue';
import InputTextFormField from '@/components/forms/parts/fields/InputTextFormField.vue';
import IntegerExtendedDataPointFormField from '@/components/forms/parts/fields/IntegerExtendedDataPointFormField.vue';
import MultiSelectFormField from '@/components/forms/parts/fields/MultiSelectFormField.vue';
import NaceCodeFormField from '@/components/forms/parts/fields/NaceCodeFormField.vue';
import NumberFormField from '@/components/forms/parts/fields/NumberFormField.vue';
import PercentageExtendedDataPointFormField from '@/components/forms/parts/fields/PercentageExtendedDataPointFormField.vue';
import PercentageFormField from '@/components/forms/parts/fields/PercentageFormField.vue';
import RadioButtonsExtendedDataPointFormField from '@/components/forms/parts/fields/RadioButtonsExtendedDataPointFormField.vue';
import RadioButtonsFormField from '@/components/forms/parts/fields/RadioButtonsFormField.vue';
import SingleSelectFormField from '@/components/forms/parts/fields/SingleSelectFormField.vue';
import YesNoBaseDataPointFormField from '@/components/forms/parts/fields/YesNoBaseDataPointFormField.vue';
import YesNoExtendedDataPointFormField from '@/components/forms/parts/fields/YesNoExtendedDataPointFormField.vue';
import YesNoFormField from '@/components/forms/parts/fields/YesNoFormField.vue';
import YesNoNaBaseDataPointFormField from '@/components/forms/parts/fields/YesNoNaBaseDataPointFormField.vue';
import YesNoNaExtendedDataPointFormField from '@/components/forms/parts/fields/YesNoNaExtendedDataPointFormField.vue';
import YesNoNaFormField from '@/components/forms/parts/fields/YesNoNaFormField.vue';
import AssuranceFormField from '@/components/forms/parts/kpiSelection/AssuranceFormField.vue';
import SubmitButton from '@/components/forms/parts/SubmitButton.vue';
import SubmitSideBar from '@/components/forms/parts/SubmitSideBar.vue';
import UploadReports from '@/components/forms/parts/UploadReports.vue';
import DatalandProgressSpinner from '@/components/general/DatalandProgressSpinner.vue';
import FailMessage from '@/components/messages/FailMessage.vue';
import SuccessMessage from '@/components/messages/SuccessMessage.vue';
import { getBasePublicFrameworkDefinition } from '@/frameworks/BasePublicFrameworkRegistry';
import { eutaxonomyFinancialsDataModel } from '@/frameworks/eutaxonomy-financials/UploadConfig';
import { ApiClientProvider } from '@/services/ApiClients';
import { type PublicFrameworkDataApi } from '@/utils/api/UnifiedFrameworkDataApi';
import { formatAxiosErrorMessage } from '@/utils/AxiosErrorMessageFormatter';
import { hasUserCompanyOwnerOrDataUploaderRole } from '@/utils/CompanyRolesUtils';
import { getFilledKpis } from '@/utils/DataPoint';
import { type DocumentToUpload, uploadFiles } from '@/utils/FileUploadUtils';
import { type Subcategory } from '@/utils/GenericFrameworkTypes';
import { smoothScroll } from '@/utils/SmoothScroll';
import { assertDefined } from '@/utils/TypeScriptUtils';
import { objectDropNull, type ObjectType } from '@/utils/UpdateObjectUtils';
import { createSubcategoryVisibilityMap } from '@/utils/UploadFormUtils';
import { checkCustomInputs, checkIfAllUploadedReportsAreReferencedInDataModel } from '@/utils/ValidationUtils';
import {
  type CompanyAssociatedDataEutaxonomyFinancialsData,
  type CompanyReport,
  DataTypeEnum,
  type EutaxonomyFinancialsData,
} from '@clients/backend';
import { FormKit } from '@formkit/vue';
import type Keycloak from 'keycloak-js';
import PrimeButton from 'primevue/button';
import Card from 'primevue/card';
import DatePicker from 'primevue/datepicker';
import Tooltip from 'primevue/tooltip';
import Tag from 'primevue/tag';
import { computed, defineComponent, inject } from 'vue';
import { type LocationQueryValue, useRoute } from 'vue-router';

export default defineComponent({
  setup() {
    return {
      getKeycloakPromise: inject<() => Promise<Keycloak>>('getKeycloakPromise'),
    };
  },
  name: 'CreateEuTaxonomyFinancials',
  components: {
    DatalandProgressSpinner,
    SubmitButton,
    SubmitSideBar,
    UploadFormHeader,
    SuccessMessage,
    FailMessage,
    FormKit,
    Card,
    PrimeButton,
    DatePicker,
    Tag,
    InputTextFormField,
    NumberFormField,
    DateFormField,
    SingleSelectFormField,
    MultiSelectFormField,
    NaceCodeFormField,
    RadioButtonsFormField,
    PercentageFormField,
    UploadReports,
    AssuranceFormField,
    IntegerExtendedDataPointFormField,
    BigDecimalExtendedDataPointFormField,
    CurrencyDataPointFormField,
    YesNoFormField,
    YesNoNaFormField,
    YesNoBaseDataPointFormField,
    YesNoNaBaseDataPointFormField,
    YesNoExtendedDataPointFormField,
    YesNoNaExtendedDataPointFormField,
    DateExtendedDataPointFormField,
    PercentageExtendedDataPointFormField,
    RadioButtonsExtendedDataPointFormField,
  },
  directives: {
    tooltip: Tooltip,
  },
  emits: ['datasetCreated'],
  data() {
    return {
      frameworkTitle: 'EU Taxonomy Dataset for a Financial Company/Service',
      formId: 'createEuTaxonomyFinancialsForm',
      waitingForData: true,
      dataDate: undefined as Date | undefined,
      companyAssociatedEuTaxonomyFinancialsData: {} as CompanyAssociatedDataEutaxonomyFinancialsData,
      eutaxonomyFinancialsDataModel,
      route: useRoute(),
      message: '',
      smoothScroll: smoothScroll,
      uploadSucceded: false,
      postEuTaxonomyFinancialsDataProcessed: false,
      messageCounter: 0,
      checkCustomInputs,
      documentsToUpload: [] as DocumentToUpload[],
      referencedReportsForPrefill: {} as { [key: string]: CompanyReport },
      namesAndReferencesOfAllCompanyReportsForTheDataset: {},
      reportingPeriod: undefined as undefined | Date,
      editMode: false,
      listOfFilledKpis: [] as Array<string>,
      templateDataId: null as LocationQueryValue | LocationQueryValue[],
      templateReportingPeriod: null as LocationQueryValue | LocationQueryValue[],
    };
  },
  computed: {
    reportingPeriodYear(): number {
      if (this.reportingPeriod) {
        return this.reportingPeriod.getFullYear();
      }
      return 0;
    },
    subcategoryVisibility(): Map<Subcategory, boolean> {
      return createSubcategoryVisibilityMap(
        this.eutaxonomyFinancialsDataModel,
        this.companyAssociatedEuTaxonomyFinancialsData.data
      );
    },
  },
  props: {
    companyID: {
      type: String,
      required: true,
    },
  },
  created() {
    this.templateDataId = this.route.query.templateDataId ?? null;
    this.templateReportingPeriod = this.route.query.reportingPeriod ?? null;
    if (
      (this.templateDataId && typeof this.templateDataId === 'string') ||
      (this.templateReportingPeriod && typeof this.templateReportingPeriod === 'string')
    ) {
      this.editMode = true;
      void this.loadEuTaxonomyFinancialsData();
    } else {
      this.waitingForData = false;
    }
    if (this.reportingPeriod === undefined) {
      this.reportingPeriod = new Date();
    }
  },
  methods: {
    /**
     * Builds an api to get and upload EU Taxonomy financials data
     * @returns the api
     */
    buildEuTaxonomyFinancialsDataApi(): PublicFrameworkDataApi<EutaxonomyFinancialsData> | undefined {
      const apiClientProvider = new ApiClientProvider(assertDefined(this.getKeycloakPromise)());
      const frameworkDefinition = getBasePublicFrameworkDefinition(DataTypeEnum.EutaxonomyFinancials);
      if (frameworkDefinition) {
        return frameworkDefinition.getPublicFrameworkApiClient(undefined, apiClientProvider.axiosInstance);
      } else return undefined;
    },
    /**
     * Loads the EuTaxonomyFinancials-Dataset identified either by the provided reportingPeriod and companyId,
     * or the dataId, and pre-configures the form to contain the data from the dataset
     */
    async loadEuTaxonomyFinancialsData(): Promise<void> {
      this.waitingForData = true;
      const euTaxonomyFinancialsDataControllerApi = this.buildEuTaxonomyFinancialsDataApi();
      if (euTaxonomyFinancialsDataControllerApi) {
        let dataResponse;
        if (this.templateDataId) {
          dataResponse = await euTaxonomyFinancialsDataControllerApi.getFrameworkData(this.templateDataId.toString());
        } else if (this.templateReportingPeriod) {
          dataResponse = await euTaxonomyFinancialsDataControllerApi.getCompanyAssociatedDataByDimensions(
            this.templateReportingPeriod.toString(),
            this.companyID
          );
        }
        if (!dataResponse) {
          this.waitingForData = false;
          throw ReferenceError('DataResponse from EuTaxonomyFinancialsDataController invalid.');
        }
        const euTaxonomyFinancialsResponseData = dataResponse.data;
        this.listOfFilledKpis = getFilledKpis(euTaxonomyFinancialsResponseData.data);
        if (euTaxonomyFinancialsResponseData?.reportingPeriod) {
          this.reportingPeriod = new Date(euTaxonomyFinancialsResponseData.reportingPeriod);
        }
        this.referencedReportsForPrefill =
          euTaxonomyFinancialsResponseData.data.general?.general?.referencedReports ?? {};
        this.companyAssociatedEuTaxonomyFinancialsData = objectDropNull(euTaxonomyFinancialsResponseData);
        this.waitingForData = false;
      }
    },

    /**
     * Sends data to add EuTaxonomyFinancials data
     */
    async postEuTaxonomyFinancialsData(): Promise<void> {
      this.messageCounter++;
      try {
        if (this.documentsToUpload.length > 0) {
          checkIfAllUploadedReportsAreReferencedInDataModel(
            this.companyAssociatedEuTaxonomyFinancialsData.data as ObjectType,
            Object.keys(this.namesAndReferencesOfAllCompanyReportsForTheDataset)
          );

          await uploadFiles(this.documentsToUpload, assertDefined(this.getKeycloakPromise));
        }

        const euTaxonomyFinancialsDataControllerApi = this.buildEuTaxonomyFinancialsDataApi();

        const isCompanyOwnerOrDataUploader = await hasUserCompanyOwnerOrDataUploaderRole(
          this.companyAssociatedEuTaxonomyFinancialsData.companyId,
          this.getKeycloakPromise
        );

        await euTaxonomyFinancialsDataControllerApi!.postFrameworkData(
          this.companyAssociatedEuTaxonomyFinancialsData,
          isCompanyOwnerOrDataUploader
        );

        this.$emit('datasetCreated');
        this.dataDate = undefined;
        this.message = 'Upload successfully executed.';
        this.uploadSucceded = true;
      } catch (error) {
        console.error(error);
        if ((error as Error).message) {
          this.message = formatAxiosErrorMessage(error as Error);
        } else {
          this.message =
            'An unexpected error occurred. Please try again or contact the support team if the issue persists.';
        }
        this.uploadSucceded = false;
      } finally {
        this.postEuTaxonomyFinancialsDataProcessed = true;
      }
    },
    /**
     * Sets the object containing the names of all stored and to-be-uploaded reports as keys, and their respective
     * fileReferences as values, and then sets the selection of reports that are to be uploaded.
     * @param reportsNamesAndReferences contains the names of all stored and to-be-uploaded reports as keys,
     * and their respective fileReferences as values
     * @param reportsToUpload contains the actual selection of reports that are to be uploaded
     */
    updateReportsSelection(reportsNamesAndReferences: object, reportsToUpload: DocumentToUpload[]) {
      this.namesAndReferencesOfAllCompanyReportsForTheDataset = reportsNamesAndReferences;
      this.documentsToUpload = [...reportsToUpload];
    },
  },
  provide() {
    return {
      namesAndReferencesOfAllCompanyReportsForTheDataset: computed(() => {
        return this.namesAndReferencesOfAllCompanyReportsForTheDataset;
      }),
      referencedReportsForPrefill: computed(() => {
        return this.referencedReportsForPrefill;
      }),
      listOfFilledKpis: computed(() => {
        return this.listOfFilledKpis;
      }),
    };
  },
});
</script>
<style scoped>
.d-center-div {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: white;
}

.uploadFormWrapper {
  input[type='checkbox'],
  input[type='radio'] {
    display: grid;
    place-content: center;
    height: 18px;
    width: 18px;
    cursor: pointer;
    margin: 0 10px 0 0;
  }
  input[type='checkbox'] {
    background-color: var(--input-text-bg);
    border: 2px solid var(--input-checked-color);
    border-radius: 2px;
  }
  input[type='radio'],
  input[type='checkbox']::before,
  input[type='radio']::before {
    content: '';
    width: 5px;
    height: 7px;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-top: -2px;
    display: none;
  }
  input[type='checkbox']::before {
    border-style: solid;
    border-color: var(--input-text-bg);
  }
  input[type='radio']::before,
  input[type='checkbox']:checked::before,
  input[type='radio']:checked::before {
    display: block;
  }
  label[data-checked='true'] input[type='radio']::before {
    display: block;
  }
  .title {
    margin: 0.25rem 0;
  }
  p {
    margin: 0.25rem;
  }
  .formFields {
    background: var(--upload-form-bg);
    padding: var(--spacing-lg);
    margin-left: auto;
    margin-bottom: 1rem;
  }
  .uploadFormSection {
    margin-bottom: 1.5rem;
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    .form-field:not(:last-child) {
      margin: 0 0 1rem 0;
      padding: 0 0 1rem 0;
      border-bottom: 1px solid var(--input-separator);
    }
  }
}

.jumpLinks {
  left: auto;
  right: 0;

  ul {
    margin: 0;
    padding: 0;

    li {
      list-style: none;
      margin: 0.5rem 0;

      a {
        color: var(--jumpLinks-color);
        text-decoration: none;

        &:hover {
          color: var(--jumpLinks-hover);
          cursor: pointer;
        }
      }
    }
  }
}
</style>
