FROM nginx:1.23.3
# Install certbot and cron and delete default nginx config
RUN apt-get update && apt-get install -y certbot cron && rm -rf /etc/nginx/* && mkdir -p /etc/nginx/conf.d && apt-get clean && rm -rf /var/lib/apt/lists/*

# Add CronJob for certificate renewal (Add 00:00 on every day)
RUN echo '0 0 * * * root  sleep $(shuf -i 0-86400 -n1); sh /scripts/renew-certificates.sh' > /etc/cron.d/certbot-renew

COPY dataland-inbound-proxy/config /etc/nginx
COPY dataland-inbound-proxy/templates/http-letsencrypt.template /etc/nginx/templates/http-letsencrypt.template
COPY dataland-inbound-proxy/dhparam.pem /certs/dhparam.pem
COPY dataland-inbound-proxy/docker-entrypoint.d/* /docker-entrypoint.d/
COPY dataland-inbound-proxy/scripts /scripts
COPY dataland-inbound-proxy/custom_errors.html /var/www/html/custom_errors.html
COPY dataland-inbound-proxy/api_errors.json /var/www/html/json_errors.json
COPY dataland-inbound-proxy/robots.txt /var/www/html/robots.txt
COPY dataland-frontend/src/assets/images /var/www/images

RUN chmod -R +x /docker-entrypoint.d && chmod -R +x /scripts

VOLUME /etc/letsencrypt

HEALTHCHECK --interval=30s --timeout=3s CMD curl -fk --header "Host: ${PROXY_PRIMARY_URL}" https://localhost/health/proxy | tee /dev/stderr | grep -q 'UP' || false
