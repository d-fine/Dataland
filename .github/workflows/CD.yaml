name: CD
env:
  DATALAND_SKYMINDERCLIENT_TOKEN: ${{ secrets.DATALAND_SKYMINDERCLIENT_TOKEN }}
  DATALAND_SKYMINDERCLIENT_USER: ${{ secrets.DATALAND_SKYMINDERCLIENT_USER }}
  SKYMINDER_URL: ${{ secrets.SKYMINDER_URL }}
  SKYMINDER_PW: ${{ secrets.SKYMINDER_PW }}
  SKYMINDER_USER: ${{ secrets.SKYMINDER_USER }}

on:
  workflow_dispatch:

jobs:
  build-prod:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
      - name: Build backend and Assemble boot jar
        run: ./gradlew dataland-backend:bootJar --no-daemon
      - name: Build frontend
        run: ./gradlew dataland-frontend:npm_run_build
      - name: Upload Backend Jar
        uses: actions/upload-artifact@v2
        with:
          name: backendJar
          path: "./dataland-backend/build/libs/dataland-backend*.jar"
      - name: Upload Dist Directory
        uses: actions/upload-artifact@v2
        with:
          name: distProdDirectories
          path: "./dataland-frontend/dist/"
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs:
      - build-prod
    steps:
      - name: Start Preview Server
        run: curl ${{ secrets.PREVIEW_STARTUP_URL }} > /dev/null
      - uses: actions/checkout@v2
      - uses: actions/download-artifact@v2
        with:
          name: backendJar
      - uses: actions/download-artifact@v2
        with:
          name: distProdDirectories
          path: dist
      - name: Deploy to Preview
        run: ./deployment/deploy_to_preview.sh dataland-backend*.jar
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

